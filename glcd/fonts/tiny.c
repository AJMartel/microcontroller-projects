#include <avr/io.h>
#include <avr/pgmspace.h> 

#include "../draw.h"

/*
 * The font mapping table.  The index of this array is the value of each char 
 * in the string; the value of the array will point to an entry in the font table.
 * 0xFF has a special meaning of "Not implemented; leave blank".
 */
prog_uchar font_tiny_map[] PROGMEM = {
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF, //0x00-0x0F
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF, //0x10-0x1F
	0xFF,0x24,0xFF,0xFF,0xFF,0x2A,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x26,0xFF,0x25,0x28, //0x20-0x2F
	0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0xFF,0xFF,0xFF,0xFF,0xFF,0x27, //0x30-0x3F
	0xFF,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18, //0x40-0x4F
	0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,0x20,0x21,0x22,0x23,0xFF,0x29,0xFF,0xFF,0xFF, //0x50-0x5F
	0xFF,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18, //0x60-0x6F
	0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,0x20,0x21,0x22,0x23,0xFF,0xFF,0xFF,0xFF,0xFF, //0x70-0x7F
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF  //0x80-0x8F
};

/*
 * A 5x3 pixel font.  The bits are read across from top left to top right, then down
 * to the next line.  Each character is represented by a 16bit unsigned integer, with 
 * bit 15 ignored.
 */
prog_uint16_t font_tiny[] PROGMEM = {
	0x2b6a,		//0, 0x0
	0x2c97,		//1
	0x73e7,		//2
	0x72cf,		//3
	0x5bc9,		//4
	0x79cf,		//5
	0x79ef,		//6
	0x7249,		//7
	0x7bef,		//8
	0x7bcf,		//9, 0x9
	0x2bed,		//A, 0xA
	0x6bae,		//B, 0xB
	0x7927,		//C
	0x6b6e,		//D
	0x79e7,		//E
	0x79e4,		//F
	0x796f,		//G, 0x10
	0x5bed,		//H, 0x11
	0x7497,		//I
	0x126f,		//J
	0x5bad,		//K
	0x4927,		//L
	0x7f6d,		//M
	0x7b6d,		//N
	0x7b6f,		//O
	0x7be4,		//P
	0x2b7b,		//Q
	0x7bad,		//R
	0x79cf,		//S
	0x7492,		//T
	0x5b6f,		//U
	0x5b6a,		//V
	0x5bfa,		//W, 0x20
	0x5aad,		//X
	0x5bd2,		//Y
	0x72a7,		//Z, 0x23
	0x2482,		//!, 0x24
	0x0002,		//.
	0x0012,		//,
	0x7282,		//?
	0x12a4,		///
	0x4889,		//\, 0x29
	0x42a1		//%, 0x2A
	
};

void glcd_draw_text(uint8_t x, uint8_t y, char* text, uint8_t o){
	uint8_t i = 0;
	while (text[i]){
		//Find the entry in the code page
		uint8_t glyphIndex = pgm_read_byte_near(font_tiny_map + (uint8_t) text[i]);

		uint8_t bitCounter = 14;
		for(uint8_t iy = y; iy < y + 5; iy++){
			for(uint8_t ix = x; ix < x + 3; ix++){
				if (pgm_read_word_near(font_tiny + glyphIndex) & _BV(bitCounter)){
					glcd_set_pixel(ix, iy, o);
				}
				bitCounter--;
			}
		}

		x += 4; //Width + 1
		i++;
	}
}
